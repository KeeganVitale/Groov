version: 1

script:
  - rm -rf AppDir | true
  - mkdir -p AppDir/usr/bin
  - mkdir -p AppDir/usr/share/groov
  - mkdir -p AppDir/usr/share/applications
  - mkdir -p AppDir/usr/share/metainfo
  - mkdir -p AppDir/usr/lib/python3/dist-packages
  - mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
  - mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
  - cp -a package AppDir/usr/share/groov/
  - cp -a assets AppDir/usr/share/groov/
  - cp -a Groov.desktop AppDir/usr/share/applications/
  - cp -a com.keegan.Groov.metainfo.xml AppDir/usr/share/metainfo/
  - install -Dm644 "assets/status icons/music_off.png" AppDir/usr/share/icons/hicolor/512x512/apps/Groov.png
  - install -Dm644 "assets/icons/groov.svg" AppDir/usr/share/icons/hicolor/scalable/apps/Groov.svg
  - install -Dm755 appimage/run-groov.sh AppDir/usr/bin/Groov
  - ln -sf Groov AppDir/usr/bin/com.keegan.Groov
  - >
    if ls appimage/wheels/*.whl >/dev/null 2>&1; then
      python3 -m pip install --no-cache-dir --no-index --find-links appimage/wheels --target AppDir/usr/lib/python3/dist-packages PySide6 mutagen pycairo;
    elif [ -d pyside6-env/lib/python3.13/site-packages/PySide6 ] && [ -d pyside6-env/lib/python3.13/site-packages/mutagen ]; then
      cp -a pyside6-env/lib/python3.13/site-packages/PySide6 AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/shiboken6 AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/pyside6-*.dist-info AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/pyside6_addons-*.dist-info AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/pyside6_essentials-*.dist-info AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/shiboken6-*.dist-info AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/mutagen AppDir/usr/lib/python3/dist-packages/;
      cp -a pyside6-env/lib/python3.13/site-packages/mutagen-*.dist-info AppDir/usr/lib/python3/dist-packages/;
      if [ -d /usr/lib/python3/dist-packages/cairo ]; then cp -a /usr/lib/python3/dist-packages/cairo AppDir/usr/lib/python3/dist-packages/; fi;
      if ls /usr/lib/python3/dist-packages/pycairo-*.dist-info >/dev/null 2>&1; then cp -a /usr/lib/python3/dist-packages/pycairo-*.dist-info AppDir/usr/lib/python3/dist-packages/; fi;
    else
      python3 -m pip install --no-cache-dir --target AppDir/usr/lib/python3/dist-packages PySide6 mutagen pycairo;
    fi
  - rm -f AppDir/usr/share/applications/python*.desktop

AppDir:
  path: ./AppDir
  app_info:
    id: Groov
    name: Groov
    icon: Groov
    version: 0.1.0
    exec: usr/bin/python3
    exec_args: -m package.main $@

  apt:
    arch: amd64
    allow_unauthenticated: false
    sources:
      - sourceline: deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
        key_url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C
      - sourceline: deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
        key_url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C
      - sourceline: deb [arch=amd64] http://security.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse
        key_url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C
    include:
      - python3
      - python3-pip
      - python3-gi
      - python3-gi-cairo
      - gir1.2-gstreamer-1.0
      - gir1.2-gst-plugins-base-1.0
      - gstreamer1.0-tools
      - gstreamer1.0-plugins-base
      - gstreamer1.0-plugins-good
      - gstreamer1.0-plugins-bad
      - gstreamer1.0-libav
      - gstreamer1.0-pulseaudio
      - libgstreamer1.0-0
      - libgstreamer-plugins-base1.0-0
      - libglib2.0-0
      - libegl1
      - libgl1
      - libxkbcommon-x11-0
      - libx11-6
      - libdbus-1-3
      - libasound2t64
      - libpulse0
      - libfontconfig1
      - libfreetype6
    exclude:
      - humanity-icon-theme
      - hicolor-icon-theme
      - adwaita-icon-theme
      - ubuntu-mono
  runtime:
    env:
      PYTHONNOUSERSITE: 1
      PYTHONPATH: "$APPDIR/usr/lib/python3/dist-packages:$APPDIR/usr/share/groov"
      GI_TYPELIB_PATH: "$APPDIR/usr/lib/x86_64-linux-gnu/girepository-1.0:$APPDIR/usr/lib/girepository-1.0"
      GST_PLUGIN_PATH: "$APPDIR/usr/lib/x86_64-linux-gnu/gstreamer-1.0:$APPDIR/usr/lib/gstreamer-1.0"
      GST_PLUGIN_SYSTEM_PATH_1_0: "$APPDIR/usr/lib/x86_64-linux-gnu/gstreamer-1.0:$APPDIR/usr/lib/gstreamer-1.0"
      QT_PLUGIN_PATH: "$APPDIR/usr/lib/python3/dist-packages/PySide6/Qt/plugins"
      QML2_IMPORT_PATH: "$APPDIR/usr/lib/python3/dist-packages/PySide6/Qt/qml"

AppImage:
  arch: x86_64
